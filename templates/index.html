<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Onboarding - Conectare la SmartBill & Stripe</title>
  <style>
    /* Basic styling for the page */
    body { font-family: Arial, sans-serif; margin: 2em; }
    form p { margin-bottom: 1em; }
    label { font-weight: bold; }
    .hidden { display: none; }
    /* Styling for the modal popup */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 2em;
      border-radius: 5px;
      max-width: 400px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Onboarding</h1>

  <!-- Div for flash messages -->
  <div id="flash-messages"></div>

  <!-- SmartBill Form -->
  <form id="smartbill-form">
    {{ form.hidden_tag() }}
    <p>
      <label for="smartbill_email">SmartBill Email:</label><br>
      {{ form.smartbill_email(size=40, id="smartbill_email") }}
    </p>
    <p>
      <label for="smartbill_token">SmartBill Token:</label><br>
      {{ form.smartbill_token(size=40, id="smartbill_token") }}
    </p>
    <p>
      <label for="cif">CIF:</label><br>
      {{ form.cif(size=40, id="cif") }}
    </p>
    <p>
      <!-- Use type="button" to avoid form submission -->
      <button type="button" id="connect-smartbill-btn">Conectare la SmartBill</button>
    </p>
  </form>

  <!-- Stripe Form (hidden until SmartBill is connected) -->
  <form id="stripe-form" class="hidden">
    <p>
      <label for="stripe_test_api_key">Test Stripe API Key:</label><br>
      {{ form.stripe_test_api_key(size=40, id="stripe_test_api_key") }}
    </p>
    <p>
      <label for="stripe_live_api_key">Live Stripe API Key:</label><br>
      {{ form.stripe_live_api_key(size=40, id="stripe_live_api_key") }}
    </p>
    <p>
      <!-- Also a button of type "button" -->
      <button type="button" id="connect-stripe-btn">Conectare la Stripe</button>
    </p>
  </form>

  <!-- Continue Button -->
  <button type="button" id="continue-btn" class="hidden">Continuare</button>

  <!-- Modal for multiple series selection -->
  <div id="series-modal" class="modal">
    <div class="modal-content">
      <h2>Selectați seria implicită</h2>
      <p>
        <label for="modal_default_series">Serii disponibile:</label><br>
        <select id="modal_default_series" name="modal_default_series" required></select>
      </p>
      <p>
        <button type="button" id="modal-confirm-btn">Salvează seria implicită</button>
        <button type="button" id="modal-cancel-btn">Renunță</button>
      </p>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM fully loaded.");

      // Utility function to show flash messages.
      function flashMessage(msg) {
        console.log("Flash: " + msg);
        const flashDiv = document.getElementById("flash-messages");
        if (flashDiv) {
          flashDiv.innerHTML = `<p style="color: green;">${msg}</p>`;
        }
      }

      // Hide the SmartBill form.
      function hideSmartbillForm() {
        const smartbillForm = document.getElementById("smartbill-form");
        if (smartbillForm) {
          smartbillForm.classList.add("hidden");
        }
      }

      // Show the Stripe form.
      function showStripeForm() {
        console.log("Showing Stripe form.");
        const stripeForm = document.getElementById("stripe-form");
        if (stripeForm) {
          stripeForm.classList.remove("hidden");
        }
      }

      // Disable the Stripe fields to gray them out.
      function disableStripeFields() {
        console.log("Disabling Stripe fields.");
        const stripeForm = document.getElementById("stripe-form");
        if (stripeForm) {
          stripeForm.querySelectorAll("input, button").forEach(el => {
            el.disabled = true;
            el.style.opacity = "0.5";
          });
        }
      }

      // Show the "Continuare" button.
      function showContinueButton() {
        console.log("Showing 'Continuare' button.");
        const contBtn = document.getElementById("continue-btn");
        if (contBtn) {
          contBtn.classList.remove("hidden");
        }
      }

      // Bind SmartBill button click.
      const smartbillBtn = document.getElementById("connect-smartbill-btn");
      if (smartbillBtn) {
        smartbillBtn.addEventListener("click", function(e) {
          e.preventDefault();
          console.log("SmartBill button clicked.");
          const smartbill_email = document.getElementById("smartbill_email").value.trim();
          const smartbill_token = document.getElementById("smartbill_token").value.trim();
          const cif = document.getElementById("cif").value.trim();
          console.log("SmartBill values:", smartbill_email, smartbill_token, cif);

          // AJAX call to get invoice series.
          fetch("/api/get_series", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ smartbill_email, smartbill_token, cif })
          })
          .then(response => response.json())
          .then(data => {
            console.log("Response from /api/get_series:", data);
            if (data.status !== "success") {
              flashMessage(data.message);
              return;
            }
            const seriesList = data.series_list;
            if (seriesList.length === 1) {
              const seriesName = seriesList[0].name || seriesList[0];
              console.log("Single series found:", seriesName);
              // Update user record with default series.
              fetch("/api/set_default_series", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ smartbill_email, smartbill_token, default_series: seriesName, cif })
              })
              .then(res => res.json())
              .then(resp => {
                console.log("Response from /api/set_default_series:", resp);
                if (resp.status === "success") {
                  flashMessage("Conectat la SmartBill cu success: " + seriesName);
                  hideSmartbillForm();
                  showStripeForm();
                } else {
                  flashMessage("Eroare la salvarea seriei implicite.");
                }
              });
            } else {
              console.log("Multiple series returned. Showing modal.");
              const modalSelect = document.getElementById("modal_default_series");
              if (modalSelect) {
                modalSelect.innerHTML = "";
                seriesList.forEach(series => {
                  const option = document.createElement("option");
                  option.value = series.name ? series.name : series;
                  option.text = series.name ? series.name : series;
                  modalSelect.appendChild(option);
                });
                const seriesModal = document.getElementById("series-modal");
                if (seriesModal) {
                  seriesModal.style.display = "flex";
                }
              }
            }
          })
          .catch(error => {
            console.error("Error in SmartBill fetch:", error);
            flashMessage("Eroare de conexiune la SmartBill.");
          });
        });
      } else {
        console.warn("SmartBill button not found.");
      }

      // Bind modal confirm button.
      const modalConfirmBtn = document.getElementById("modal-confirm-btn");
      if (modalConfirmBtn) {
        modalConfirmBtn.addEventListener("click", function() {
          console.log("Modal confirm clicked.");
          const smartbill_email = document.getElementById("smartbill_email").value.trim();
          const smartbill_token = document.getElementById("smartbill_token").value.trim();
          const default_series = document.getElementById("modal_default_series").value;
          const cif = document.getElementById("cif").value.trim();
          fetch("/api/set_default_series", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ smartbill_email, smartbill_token, default_series, cif })
          })
          .then(res => res.json())
          .then(resp => {
            console.log("Modal response from /api/set_default_series:", resp);
            const seriesModal = document.getElementById("series-modal");
            if (seriesModal) seriesModal.style.display = "none";
            if (resp.status === "success") {
              flashMessage("Conectat la SmartBill cu success: " + default_series);
              hideSmartbillForm();
              showStripeForm();
            } else {
              flashMessage("Eroare la salvarea seriei implicite.");
            }
          })
          .catch(error => {
            console.error("Error in modal fetch:", error);
            const seriesModal = document.getElementById("series-modal");
            if (seriesModal) seriesModal.style.display = "none";
            flashMessage("Eroare de conexiune.");
          });
        });
      } else {
        console.warn("Modal confirm button not found.");
      }

      // Bind modal cancel button.
      const modalCancelBtn = document.getElementById("modal-cancel-btn");
      if (modalCancelBtn) {
        modalCancelBtn.addEventListener("click", function() {
          console.log("Modal cancel clicked.");
          const seriesModal = document.getElementById("series-modal");
          if (seriesModal) seriesModal.style.display = "none";
          flashMessage("Selectia seriei a fost anulată.");
        });
      } else {
        console.warn("Modal cancel button not found.");
      }

      // Bind Stripe button click.
      const stripeBtn = document.getElementById("connect-stripe-btn");
      if (stripeBtn) {
        stripeBtn.addEventListener("click", function(e) {
          e.preventDefault();
          console.log("Stripe button clicked.");
          const stripe_test_api_key = document.getElementById("stripe_test_api_key").value.trim();
          const stripe_live_api_key = document.getElementById("stripe_live_api_key").value.trim();
          if (!stripe_test_api_key || !stripe_live_api_key) {
            flashMessage("Vă rugăm să introduceți ambele chei Stripe.");
            return;
          }
          fetch("/api/stripe_create_webhooks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stripe_test_key: stripe_test_api_key, stripe_live_key: stripe_live_api_key })
          })
          .then(response => response.json())
          .then(data => {
            console.log("Response from /api/stripe_create_webhooks:", data);
            if (data.status === "success") {
              flashMessage("Stripe conectat cu success! " + data.message);
              showContinueButton();
              disableStripeFields();
            } else {
              flashMessage("Eroare la conectarea Stripe: " + data.message);
            }
          })
          .catch(error => {
            console.error("Error in Stripe fetch:", error);
            flashMessage("Eroare de conexiune la Stripe.");
          });
        });
      } else {
        console.warn("Stripe button not found.");
      }

      // Bind continue button.
      const continueBtn = document.getElementById("continue-btn");
      if (continueBtn) {
        continueBtn.addEventListener("click", function() {
          console.log("'Continuare' button clicked.");
          window.location.href = "/dashboard";
        });
      } else {
        console.warn("Continue button not found.");
      }
    });
  </script>
</body>
</html>